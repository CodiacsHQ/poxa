<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Poxa Console</title>
<script src="/static/js/jquery.min.js"></script>
<script src="/static/js/hmac-sha256.js"></script>
<link rel="stylesheet" type="text/css" href="/static/css/bootstrap.min.css"/>
<link rel="stylesheet" type="text/css" href="/static/css/bootstrap-theme.min.css"/>
<script type="text/javascript">

var websocket;
var counter = 0;
$(document).ready(init);

function init() {
  if(!("WebSocket" in window)) {
    $('#status').append('<p><span style="color: red;">websockets are not supported </span></p>');
  };
  $('#connect').submit(function(event) {
    var appKey = $('#appKey').val();
    var secret = $('#secret').val();
    connect(appKey, secret);
    event.preventDefault();
  });
};

function connect(appKey, secret) {
  var qs = authQS(appKey, secret);
  var host = window.location.host;
  websocket = new WebSocket("ws://" + host  + "/console?" + qs);
  websocket.onopen = function(evt) { onOpen(evt) };
  websocket.onclose = function(evt) { onClose(evt) };
  websocket.onmessage = function(evt) { onMessage(evt) };
  websocket.onerror = function(evt) { onError(evt) };
};

function authQS(appKey, secret) {
  var auth_key = appKey;
  var auth_timestamp = new Date().getTime();
  var params = { auth_key:auth_key,
                 auth_timestamp:auth_timestamp,
                 auth_version:"1.0" } ;
  var auth_signature = CryptoJS.HmacSHA256("GET\n/console\n" + $.param(params), secret).toString();
  return $.param($.extend({ }, params, { auth_signature:auth_signature }));
}

function disconnect() {
  websocket.close();
};

function toggle_connection(){
  if(websocket.readyState == websocket.OPEN){
    disconnect();
  } else {
    connect();
  };
};

function onOpen(evt) {
  $("#connect").hide();
  console.log("Websocket connected");
};

function onClose(evt) {
  console.log("Websocket closed");
  $("#connect").show();
};

function onMessage(evt) {
  incrementCounter();
  var data = JSON.parse(evt.data);
  addEvent(data.type, data.socket, data.details, data.time);
};

function onError(evt) {
  console.log("Error: " + evt);
};

function incrementCounter() {
  counter++;
  $('#counter').text(counter);
};

function addEvent(type, socket, details, time) {
  var label = '<td class="' + labelClass(type) + '">' + type + '</td>';
  var row = label +
            '<td>' + socket + '</td>' +
            '<td>' + details + '</td>' +
            '<td>' + time + '</td>';
  $('#events > tbody:last').prepend('<tr>' + row + '</tr>');
};

function labelClass(type) {
  switch (type) {
    case 'Connection':
      return 'success';
    case 'Disconnection':
      return 'danger';
    case 'Subscribed':
      return 'info';
    case 'Unsubscribed':
      return 'info';
    case 'Occupied':
      return 'info';
    case 'Vacated':
      return 'info';
    default:
      return 'warning';
  }
};

</script>
</head>

<body>
<div class="panel panel-default">
  <div id="status"></div>
  <div class="panel-heading">
    <span class="panel-title">Poxa Console</span>
    <form id="connect" class="form-inline" role="form">
      <div class="form-group">
        <label class="sr-only" for="appKey">App Key</label>
        <input class="form-control" id="appKey" placeholder="Enter App Key">
      </div>
      <div class="form-group">
        <label class="sr-only" for="secret">Secret</label>
        <input type="password" class="form-control" id="secret" placeholder="Secret">
      </div>
      <button type="submit" class="btn btn-default">Connect</button>
    </form>
  </div>
  <div class="panel-body col-md-8">
    <h3>Events <span class="badge" id="counter"></span></h3>
    <table id="events" class="table table-striped table-hover">
      <thead>
        <tr>
          <th>Type</th>
          <th>Socket</th>
          <th>Details</th>
          <th>Time</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>
</div>
</body>
</html>
